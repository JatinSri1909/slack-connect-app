<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slack OAuth Callback</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: #f8f9fa;
        }
        .callback-container {
            text-align: center;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .success {
            color: #28a745;
        }
        .error {
            color: #dc3545;
        }
        .loading {
            color: #666;
        }
    </style>
</head>
<body data-backend-url="">
    <div class="callback-container">
        <div id="status" class="loading">
            <h3>Connecting to Slack...</h3>
            <p>Please wait while we complete the connection.</p>
        </div>
    </div>

    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const error = urlParams.get('error');
        const statusEl = document.getElementById('status');

        if (error) {
            statusEl.className = 'error';
            statusEl.innerHTML = `
                <h3>Connection Failed</h3>
                <p>Error: ${error}</p>
                <p>Please close this window and try again.</p>
            `;
            
            // Send error to parent window
            if (window.opener) {
                window.opener.postMessage({
                    type: 'SLACK_OAUTH_ERROR',
                    error: `OAuth authorization failed: ${error}`
                }, '*');
            }
        } else if (code) {
            // Send the authorization code to your backend
            // Get backend URL from data attribute or use default
            const backendUrl = document.body.dataset.backendUrl || 
                (window.location.hostname === 'localhost' ? 'http://localhost:5000' : 'https://slack-connect-server-1.onrender.com');
            fetch(`${backendUrl}/api/auth/slack/callback?code=${code}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        statusEl.className = 'success';
                        statusEl.innerHTML = `
                            <h3>âœ“ Connected Successfully!</h3>
                            <p>Connected to <strong>${data.team.name}</strong></p>
                            <p>You can close this window now.</p>
                        `;
                        
                        // Store team info and notify parent window
                        const teamData = {
                            id: data.team.id,
                            name: data.team.name
                        };
                        
                        localStorage.setItem('connected_slack_team', JSON.stringify(teamData));
                        
                        if (window.opener) {
                            window.opener.postMessage({
                                type: 'SLACK_OAUTH_SUCCESS',
                                team: teamData
                            }, '*');
                        }
                        
                        // Auto-close after 3 seconds
                        setTimeout(() => {
                            window.close();
                        }, 3000);
                        
                    } else {
                        throw new Error(data.error || 'Unknown error occurred');
                    }
                })
                .catch(error => {
                    statusEl.className = 'error';
                    statusEl.innerHTML = `
                        <h3>Connection Failed</h3>
                        <p>Error: ${error.message}</p>
                        <p>Please close this window and try again.</p>
                    `;
                    
                    if (window.opener) {
                        window.opener.postMessage({
                            type: 'SLACK_OAUTH_ERROR',
                            error: error.message
                        }, '*');
                    }
                });
        } else {
            statusEl.className = 'error';
            statusEl.innerHTML = `
                <h3>Invalid Callback</h3>
                <p>No authorization code received.</p>
                <p>Please close this window and try again.</p>
            `;
        }
    </script>
</body>
</html>